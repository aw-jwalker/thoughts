#!/bin/bash
# thoughts - Central thoughts management CLI
#
# A simplified bash-based implementation inspired by HumanLayer's thoughts system.
# Manages developer notes, research, and handoffs across multiple repositories.
#
# Usage:
#   thoughts init [project-name]  - Initialize thoughts for a project
#   thoughts uninit [--force]     - Remove thoughts from a project
#   thoughts sync [message]       - Sync thoughts to remote
#   thoughts status               - Show sync status
#   thoughts config [--edit]      - View/edit configuration
#   thoughts cd                   - Print path to thoughts repo

set -e

THOUGHTS_REPO="$HOME/repos/thoughts"
SCRIPTS_DIR="$THOUGHTS_REPO/scripts"

# Source common functions for status command
source "$SCRIPTS_DIR/common.sh" 2>/dev/null || true

case "${1:-help}" in
    init)
        shift
        "$SCRIPTS_DIR/init.sh" "$@"
        ;;
    uninit)
        shift
        "$SCRIPTS_DIR/uninit.sh" "$@"
        ;;
    sync)
        shift
        "$SCRIPTS_DIR/sync.sh" "$@"
        ;;
    config)
        shift
        "$SCRIPTS_DIR/config.sh" "$@"
        ;;
    status)
        thoughts_repo=$(get_thoughts_repo 2>/dev/null || echo "$THOUGHTS_REPO")
        current_repo=$(get_current_repo 2>/dev/null || pwd)

        echo "Thoughts Repository Status"
        echo "=================================================="
        echo ""

        # Configuration
        if [ -f "$CONFIG_FILE" ]; then
            echo "Configuration:"
            echo "  Thoughts repo:   $thoughts_repo"
            echo "  User:           $(get_user)"
            echo "  Mapped repos:   $(jq '.repoMappings | length' "$CONFIG_FILE" 2>/dev/null || echo "0")"
            echo ""
        fi

        # Current repo status
        local_mapping=$(get_repo_mapping "$current_repo" 2>/dev/null || echo "")
        echo "Current Repository:"
        echo "  Path: $current_repo"
        if [ -n "$local_mapping" ]; then
            echo "  Thoughts directory: repos/$local_mapping"
            if [ -d "$current_repo/thoughts" ]; then
                echo "  Status: Initialized"
            else
                echo "  Status: Mapped but not initialized (run 'thoughts init')"
            fi
        else
            echo "  Status: Not mapped"
        fi
        echo ""

        # Git status
        cd "$thoughts_repo"
        echo "Git Status:"
        git status --short || echo "  (not a git repository)"
        echo ""

        if git remote get-url origin &>/dev/null; then
            echo "Remote: $(git remote get-url origin)"
            git fetch --quiet 2>/dev/null || true
            LOCAL=$(git rev-parse HEAD 2>/dev/null)
            REMOTE=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master 2>/dev/null || echo "")
            if [ -n "$REMOTE" ]; then
                AHEAD=$(git rev-list --count "$REMOTE..$LOCAL" 2>/dev/null || echo "0")
                BEHIND=$(git rev-list --count "$LOCAL..$REMOTE" 2>/dev/null || echo "0")
                echo "Ahead: $AHEAD, Behind: $BEHIND"

                # Auto-pull if behind
                if [ "$BEHIND" -gt 0 ]; then
                    echo ""
                    echo "Pulling latest changes..."
                    git pull --rebase 2>/dev/null && echo "Pulled successfully" || echo "Warning: Could not pull"
                fi
            fi
        else
            echo "No remote configured"
        fi
        echo ""

        # Last commit
        echo "Last commit:"
        git log -1 --pretty=format:"  %h %s (%cr)" 2>/dev/null || echo "  (no commits)"
        echo ""
        echo ""

        # Projects with thoughts
        echo "Projects with thoughts:"
        if [ -d "$thoughts_repo/repos" ]; then
            ls -1 "$thoughts_repo/repos" 2>/dev/null | while read -r project; do
                echo "  - $project"
            done
        else
            echo "  (none)"
        fi
        ;;
    cd)
        echo "$THOUGHTS_REPO"
        ;;
    help|--help|-h|"")
        echo "thoughts - Central thoughts management CLI"
        echo ""
        echo "A system for managing developer notes, research, and handoffs"
        echo "across multiple repositories in a central location."
        echo ""
        echo "Usage:"
        echo "  thoughts init [project-name]  Initialize thoughts for current project"
        echo "  thoughts uninit [--force]     Remove thoughts from current project"
        echo "  thoughts sync [message]       Sync thoughts to remote"
        echo "  thoughts status               Show sync status"
        echo "  thoughts config [--edit]      View/edit configuration"
        echo "  thoughts cd                   Print path to thoughts repo"
        echo ""
        echo "Structure (after init):"
        echo "  thoughts/"
        echo "    {user}/      Your personal notes for this repo"
        echo "    shared/      Team-shared notes for this repo"
        echo "    global/      Cross-repository thoughts"
        echo "    searchable/  Hard links for AI tools (created by sync)"
        echo "    CLAUDE.md    Instructions for AI assistants"
        echo ""
        echo "Examples:"
        echo "  cd ~/repos/myproject && thoughts init"
        echo "  thoughts sync 'Added research notes'"
        echo "  cd \$(thoughts cd)"
        echo "  thoughts config --edit"
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'thoughts help' for usage"
        exit 1
        ;;
esac
